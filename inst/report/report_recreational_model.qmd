---
title: "BioDT - The Recreational Model"
authors: "Maddalena Tigli, Joe Marsh Rossney, Christopher Andrews"
date: "June 2025"
format:
  html:
    embed-resources: true
    self-contained: true
    toc: true
    toc-location: right
---

```{r, echo=FALSE}
library(magrittr)
library(biodt.recreation)

source(here::here("inst", "report", "functions_report.R"))

water <- terra::rast(here::here("inst", "extdata", "rasters", "Bush", "original", "Water.tif"))

slsra <- terra::rast(here::here("inst", "extdata", "rasters", "Bush", "SLSRA.tif"))

fips_n <- terra::rast(here::here("inst", "extdata", "rasters", "Bush", "FIPS_N.tif"))

fips_i <- terra::rast(here::here("inst", "extdata", "rasters", "Bush","original", "FIPS_I.tif"))



# the box of bush estate
e <- terra::ext(water)
coords <- matrix(c(
  e$xmin, e$ymin,
  e$xmax, e$ymin,
  e$xmax, e$ymax,
  e$xmin, e$ymax,
  e$xmin, e$ymin # close polygon
), ncol = 2, byrow = TRUE)
bbox_poly <- terra::vect(coords,
  type = "polygons",
  crs = terra::crs(water)
) %>%
  sf::st_as_sf() %>%
  sf::st_transform(crs = 4326)

base_map <- 
  leaflet::leaflet() %>%
  leaflet::addProviderTiles("OpenStreetMap.Mapnik", options = leaflet::providerTileOptions(zIndex = 0, noWrap = TRUE), group = "Streets") %>%
  leaflet::addProviderTiles("Esri.WorldImagery", options = leaflet::providerTileOptions(zIndex = 0, noWrap = TRUE), group = "Satellite") %>%
  leaflet::addPolygons(
    data = bbox_poly,
    color = "black",
    weight = 3,
    fill = FALSE
  ) 

```

## 1. Scope of the Model

The **recreational potential model** (RP Model) was developed as part of the *Cultural Ecosystem Services prototype Digital Twin (CES-pDT)* workpackage within the [BioDT](https://biodt.eu/) project. The *([CES-pDT](https://app.biodt.lifewatch.eu/app_proxy/b6d219cf-f46c-4ef5-a517-e9a7289f81fa/?_inputs_&app-navbar=%22CES%22#tab-6956-4))* has two [independent]{.underline} core models:

-   the Biodiversity model (developed by Simon Rolph and Dylan Carbone, UK Centre for Ecology & Hydrology, Wallingford, United Kingdom): aims *at estimating biodiversity levels across mammals, birds, plant and insects.*

-   the Recreational Potential model (developed by Jan Dick, Chris Andrews, Maddalena Tigli, Megan Williams and Joe Marsh Rossney, UK Centre for Ecology & Hydrology, Edinburgh, United Kingdom): aims at *estimating the landscapes' capacity to provide opportunities for outdoor recreation based on varying user interests.*

This report specifically documents the Recreational Potential (RP) Model, detailing its methodology, data sources, operational mechanisms, and outlining areas for future refinement and development.

**CHRISTOPHER TO ADD MORE INFO? MAYBE THERE ARE SOME LIT SOURCES USED?**

## 2. The model

### 2.1. Model description

```{mermaid}
flowchart LR
 subgraph s1["compute recreational potential"]
        C[("cropping of the 4<br>components file to the<br>extent of interest")]
        E["Compute each component's<br>contribution"]
        F["Rescale to unit interval"]
  end
    A("Definition of the<br><i>persona preferences</i>") ---> E
    B("Definition of the<br><i>area of interest</i>") --> C
    C --> E
    E --> F
    F --> G["recreational potential spatRast"]
    style s1 fill:#FFF9C4
    style A color:#000000
    style B color:#000000
    style C color:#000000
    style E color:#000000
    style F color:#000000
    style G color:#000000
```

The Recreational Potential (RP) Model estimates the recreational value of landscapes using four key components, each represented by a raster file:

1.  Landscape Component (SLSRA.tif)

2.  Natural Features Component (FIPS_N.tif)

3.  Infrastructure Component (FIPS_I.tif)

4.  Water Component (Water.tif)

Each of the four component raster files contains multiple layers, with each layer representing a specific feature. Each raster covers the entire domain of the model (with a 20mx20m resolution), currently Scotland (see [2.3. The underlying data]).

The values in these raster layers range from 0 to 1, interpreted as follows:

-   1 indicates that the feature is present in that cell.

-   0 or NAs indicates that the feature is absent from that cell

-   Values between 0 and 1 are present in the features/layers of the Infrastructure and Water components rasters, and reflect the proximity from nearby features. This continuous scale allows the RP model to incorporate how areas near e.g., a loch, can still contribute to the recreational potential, even if they do not directly contain the feature

The four rasters form the basis for calculating the Recreational Potential (RP) across the landscape.

To run the RP model the user must define:

-   Area of interest: defined using a bounding box ([terra::ext()](https://www.rdocumentation.org/packages/terra/versions/0.8-6/topics/extent) in R).

-   Persona preferences: a CSV file assigning a score (0–10) to each of the 87 features (see [2.3. The underlying data]), reflecting the persona's interest in each (see example persona file "presets.csv" ).

#### RP model processing steps 

1.  **Cropping the raster files**

The model first crops each of the four component rasters to the specified area of interest. Using the terra package in R, the bounding box is converted to a vector polygon with terra::vect(), and then used to crop the raster via terra::crop().

2.  **Calculating each components contribution**

For each cell (20m x 20m), the model extracts values from all relevant layers (features), multiplies them by the corresponding persona score, and computes a weighted sum across layers. This results in one new raster per component that reflects the component’s contribution based on the persona preferences.

3.  **Re-scale to unit interval**

Each of the components contribution rasters is re-scaled using "min-max normalization":

$$
scaled.value = (x-min)/mix-min
$$

Minimum values are mapped as 0, maximum values are mapped as 1, and all the intermediate values are proportionally scaled.

4.  **Combining the components RP**

The four normalized component rasters are summed cell by cell. The resulting raster is then re-scaled again (min-max normalization) to produce the final Recreational Potential raster.

The model's output is a SpatRaster object (that can be saved as a .tif) with five layers:

1.  "SLSRA": the RP of the landscape component

2.  "FIPS_N": the RP of the natural features component

3.   "FIPS_I": the RP of the infrastructure component

4.   "Water": the RP of the water component

5.   "Recreational_Potential": the combined RP

In all layers, values range from 0 to 1, where higher values (closer to 1) indicate greater recreational potential.

Because the model output is a result of the normalization of recreational potential of a specific area of interest, the values are relative within that area. This means that running the model with a different geographic extent will yield to different scores for the same features, even if the underlying data is unchanged.

### 2.2. Example run

We demonstrate the RP Model applied to the Bush Estate area (nearby Edinburgh) using two contrasting personas: a hard recreationalist and a soft recreationalist. The resulting maps illustrate how different preferences lead to different areas being highlighted for recreational value.

1.  **Hard recreationalist exmaple**

Here we show a model run the Bush Estate area using a "hard recreationalist" example of persona (saved as "Hard_Recreationalist" in "presets.csv" ). Key features preferences for this persona are:

```{r, echo=FALSE, message=FALSE}

hard_recr <- 
  data.frame(get_example_persona())%>%
  tibble::rownames_to_column(var = "Name")%>%
  dplyr::select(Name,
                Score = `get_example_persona..`)

meaningful_scores <- summarise_persona_scores(hard_recr)
  
knitr::kable(meaningful_scores,format = "html",
             caption = "Features scored the highest and the lowest in the hard recreationalist persona")
```

This persona highly values remote, challenging environments and avoids built-up or highly managed areas.

```{r, echo=FALSE, warning=FALSE, results='hide', message = FALSE}
hard_recreationalist <- get_example_persona()
bush_estate <- get_example_bbox()
data_dir <- get_example_data_dir()

# Compute all layers
layers_HR <- compute_potential(hard_recreationalist,
                            bush_estate,
                            data_dir)
```

```{r, echo=FALSE }
build_rp_map(base_map, RP_output = layers_HR)
```

2.  **Soft recreationalist example**

Here we show a model run the Bush Estate area using a "soft recreationalist" example of persona (saved as "Soft_Recreationalist" in "presets.csv"). Key features preferences for this persona are:

```{r, echo=FALSE}

soft_recr <- 
  read.csv(here::here("inst", "extdata", "personas", "presets.csv"))%>%
  dplyr::select(Name = index,
                Score = Soft_Recreationalist)

meaningful_scores <- summarise_persona_scores(soft_recr)
  
knitr::kable(meaningful_scores,format = "html",
             caption = "Features scored the highest and the lowest in the soft recreationalist persona")
```

Soft recreationalists are drawn to tranquil, accessible landscapes and natural water features, avoiding steep or harsh terrain.

```{r, echo=FALSE, warning=FALSE, results='hide', message = FALSE}
soft_recreationalist <- 
  load_persona(get_preset_persona_file(), "Soft_Recreationalist")
  
# Compute all layers
layers_SR <- compute_potential(soft_recreationalist,
                            bush_estate,
                            data_dir)
```

```{r, echo=FALSE}
build_rp_map(base_map, RP_output = layers_SR)
```

### 2.3. The underlying data

The methodology used to create each of the four components' Scotland wide raster file is described in detail in this section.

An overview of the raster files of all four component for the Easter Bush area (the same extent displayed in the example model run) is also displayed.

```{r, echo=FALSE, results='hide'}
print(paste("water:", length(names(water))))
print(paste("slsra:", length(names(slsra))))
print(paste("fips_n:", length(names(fips_n))))
print(paste("fips_i:", length(names(fips_i))))
```

+-------------+--------------------------------------------------------------------------------------------------------------------+
| name raster | description                                                                                                        |
+=============+====================================================================================================================+
| SLSRA.tif   | ***Landscape component***                                                                                          |
|             |                                                                                                                    |
|             | This includes data on land cover type, landscape designations and conservation, and farmland of high nature value. |
|             |                                                                                                                    |
|             | resolution: 20x20\                                                                                                 |
|             | extent: whole of Scotland\                                                                                         |
|             | crs: British National Grid\                                                                                        |
|             | nr. features (layers): 40                                                                                          |
+-------------+--------------------------------------------------------------------------------------------------------------------+
| FIPS_N.tif  | ***Natural Features component***                                                                                   |
|             |                                                                                                                    |
|             | This includes data on land form types, soil types and slope.                                                       |
|             |                                                                                                                    |
|             | resolution: 20x20\                                                                                                 |
|             | extent: whole of Scotland\                                                                                         |
|             | crs: British National Grid\                                                                                        |
|             | nr. features (layers): 24                                                                                          |
+-------------+--------------------------------------------------------------------------------------------------------------------+
| Water.tif   | ***Water component***                                                                                              |
|             |                                                                                                                    |
|             | This includes data on water feature types, as the presence of a lake or river.                                     |
|             |                                                                                                                    |
|             | resolution: 20x20\                                                                                                 |
|             | extent: whole of Scotland\                                                                                         |
|             | crs: British National Grid\                                                                                        |
|             | nr. features (layers): 13                                                                                          |
+-------------+--------------------------------------------------------------------------------------------------------------------+
| FIPS_I.tif  | ***Infrastructure component***                                                                                     |
|             |                                                                                                                    |
|             | This includes data on road and track, footpaths and cycle networks.                                                |
|             |                                                                                                                    |
|             | \                                                                                                                  |
|             | resolution: 20x20\                                                                                                 |
|             | extent: whole of Scotland\                                                                                         |
|             | crs: British National Grid\                                                                                        |
|             | nr. features (layers): 10                                                                                          |
+-------------+--------------------------------------------------------------------------------------------------------------------+

: Description of the 4 components' raster files.

1.  **Landscape component**

**CHRISTOPHER TO PROVIDE INFO ON THIS RASTRE FILE**

```{r, echo=FALSE}
slsra_variables <- 
  read.csv(here::here("inst", "extdata", "config", "config.csv"))%>%
  dplyr::filter(Component == "SLSRA")

slsra_variables <- slsra_variables %>%
  dplyr::mutate(nr = c(1:nrow(slsra_variables)))%>%
  dplyr::select(nr, Name, Description)

knitr::kable(slsra_variables,format = "html",  caption = "Landscape component features")
```

```{r, echo=FALSE}

make_layer_map(rstack = slsra,  base_map = base_map,
               show_index = 5, #start with SLSRA_LCM_6 selected as example
               color = "#386641")


```

2.  **Natural Features component**

**CHRISTOPHER TO PROVIDE INFO ON THIS RASTRE FILE**

```{r, echo=FALSE}
fips_n_variables <- 
  read.csv(here::here("inst", "extdata", "config", "config.csv"))%>%
  dplyr::filter(Component == "FIPS_N")

fips_n_variables <- fips_n_variables %>%
  dplyr::mutate(nr = c(1:nrow(fips_n_variables)))%>%
  dplyr::select(nr, Name, Description)

knitr::kable(fips_n_variables,format = "html",  caption = "Natural Features component features")
```

```{r, echo=FALSE}
make_layer_map(rstack = fips_n,  base_map = base_map,
               show_index = 5, #start with FIPS_N_Landform_16 selected as example
               color = "#CBA340")

```

3.  **Infrastructure component**

```{r, echo=FALSE}
fips_i_variables <- 
  read.csv(here::here("inst", "extdata", "config", "config.csv"))%>%
  dplyr::filter(Component == "FIPS_I")

fips_i_variables <- fips_i_variables %>%
  dplyr::mutate(nr = c(1:nrow(fips_i_variables)))%>%
  dplyr::select(nr, Name, Description)

knitr::kable(fips_i_variables,format = "html",  caption = "Infrastructure component features")
```

The infrastructure component is derived from a raster indicating the presence or absence of infrastructure features. This original raster, labeled **"original"** in the Easter Bush example map, contains: 1 for cells where the feature is present, and 0 or NAs for cells where the feature is absent. **CHRISTOPHER TO ADD WHERE THE ORIGINAL RASTER CAME FROM**.

To account for proximity effects, the distance from each cell to the nearest infrastructure feature was calculated using the terra::distance() function in R. The resulting raster, labeled **"distance"** in the example map, contains the distance in meters from the center of each cell to the nearest feature. \
Because this operation is memory-intensive at the national scale, the original Scotland-wide raster was divided into 20 spatial "windows".To ensure accuracy near window boundaries, each window was processed with an additional 10 km buffer, allowing distances to be computed to features located in neighboring windows.

Finally, considering only the cells that were \<= 500m distance from a feature (everything with features further away than that got assigned a NAs), the values were re-scaled from 0 to 1 (1 = present in cell, and then decreasing score as you get away from that cell). This raster is named "**scored**" in the example map, using the distance decay function **JOE TO ADD PAPER FOR THIS FUNCTION + kappa and alpha values:**

$$
distance (m) = \frac{\kappa + 1}{\kappa + \exp(\alpha x)}
$$

Where *kappa* has a value of XX and *alpha* has a value of XX.

The "scored" raster is what it is utilized by the RP model.

```{r, echo=FALSE, out.height = 650}

fips_i_rstack <- list(
  "original" = fips_i,
  "distance" = terra::rast(here::here("inst", "extdata", "rasters", "Bush", "dist", "FIPS_I_dist.tif")),
  "scored" = terra::rast(here::here("inst", "extdata", "rasters", "Bush", "FIPS_I.tif"))
  )

make_layer_map_dist(rstack = fips_i_rstack, base_map,
                    show_index = 2,
                    color_original = "#DA627D")
```

4.  **Water component**

The water component is derived from a raster indicating the presence or absence of infrastructure features. This original raster, labeled **"original"** in the Easter Bush example map, contains: 1 for cells where the feature is present, and 0 or NAs for cells where the feature is absent. **CHRISTOPHER TO ADD WHERE THE ORIGINAL RASTER CAME FROM**.

Then, using the same methodology applied to the infrastructure component's raster the **"distance**" and **"scored"** raster were created.

The "scored" raster is what it is utilized by the RP model.

```{r, echo=FALSE}
water_variables <- read.csv(here::here("inst", "extdata", "config", "config.csv")) %>%
  dplyr::filter(Component == "Water")

water_variables <- water_variables %>%
  dplyr::mutate(nr = c(1:nrow(water_variables)))%>%
  dplyr::select(nr, Name, Description)

knitr::kable(water_variables,format = "html",  caption = "Water component features")
```

```{r, echo=FALSE, out.height = 650}
water_rstack <- list(
  "original" = water,
  "distance" = terra::rast(here::here("inst", "extdata", "rasters", "Bush", "dist", "Water_dist.tif")),
  "scored" = terra::rast(here::here("inst", "extdata", "rasters", "Bush", "Water.tif"))
  )

make_layer_map_dist(rstack = water_rstack, base_map,
                    show_index = 6, # "water rivers 3 distance"
                    color_original = "#4E6766")
```

## 3. The Shiny app for the "watches" spin off

**JOE TO ADD SECTION, MAYBE PROVIDE LINK?**

## 4. Compertamentalization

**JOE TO ADD SECTION, I HAVE NO IDEA WHAT WAS DONE HERE**

## 5. Running the model for the whole of Scotland

**MADDA TO ADD SECTION ONCE MODEL HAS RUN**

## 6. Lessons learned

1.  **Transitioning to terra::SpatRaster Improved Performance**

One of the most significant improvements came from switching from the legacy raster::Raster to the more modern and efficient terra::SpatRaster format. This change brought several key benefits:

-   Faster processing of raster operations such as cropping, masking, and mathematical transformations.

-   Better memory management, particularly for large datasets covering all of Scotland with a high resolutions.

-   Improved integration with spatial vector formats and compatibility with modern spatial workflows in R.

Overall, the use of the package terra reduced computational overhead significantly (see report "Optimizing BioDT Recreational Potential (RT) model run-time").

2.  **Pre-processing at the National Scale Greatly Reduces Run-time**

Pre-processing component rasters at the national (Scotland-wide) scale, rather than performing these operations at run-time for each user-defined area. Pre-processing included:

-   Standardizing spatial properties (extent, resolution, projection) across all four component rasters to ensure seamless overlay and computation.

-   Pre-computing distance rasters, to avoid repeated and costly distance calculations during model runs.

-   Pre-calculating scored rasters using predefined thresholds and decay functions, making them immediately usable for user-defined queries.

Overall, the use of this approach has reduced computational overhead significantly (see report "Optimizing BioDT Recreational Potential (RT) model run-time").

3.  **JOE to add lessons on shiny/compartmentalization if any**
4.  **CHRIS to add any other lessons if he has any**

##  6. Future improvements

As the RP Model was developed as a prototype, several enhancements could improve its usability, accuracy, and performance. The following areas have been identified for future development:

1.  **Simplifying feature scoring**

    Currently, the model requires users to score 87 individual features across the four components. While this allows for a detailed definition of the "persona profile", it can be time-consuming for users. A future version could:

    -   Group similar features into broader thematic categories (e.g., “mountain terrain,” “urban infrastructure,” “wetlands”), allowing users to score these aggregated categories rather than individual layers, making the scoring process more intuitive and efficient

    -   Maintain the option to score each of the 87 featre for expert users who want fine control

    A simpler model configuration could make the model accessible to more users.

2.  **Connecting to Live, regularly updated data-sets**

    Currently the model relies on static raster layers to represents the components, which may become outdated as landscapes change or as better data becomes available. A future version of the model could:

    -   Link the model to live/regularly updated data-sets
    -   Automatically generate the "original" raster layers for each component when updated data becomes available

3.  **User-defined weighting components**

    Currently the RP model assumes that all four components contribute equally to the Recreational Potential score. However, not all personas may value these components equally. A future version of the model could:

    -   Allow users to specify custom weights for each of the four components (e.g. ,50% landscape, 20% water, 15% infrastructure and 15% natural features)

4.  **Expanding the number of Persona presets available**

    To make the RP model more accessible to casual non-technical users, and to encourage exploration and experimentation with it, a future version of the model could:

    -   Provide persona preset for common user types (e.g., hikers, birdwatchers, families, cyclists etc.)
    -   Define both features scores and components weights for each persona

5.  **Include seasonal dynamics**

    Currently, the RP model assumes a static Recreation Potential throughout the year, however, this can vary with seasons, and weather conditions. A future version of the model could:

    -   integrate temporal layers by asking the *persona* to specify what season they are intending to recreate in. Then the model could have the underlying components starting values to have different values for different seasons, accounting for trail closures or flooding risks etc.)

6.  **Allow for "future scenarios"**

    With the aim of making the RP model the more relevant to policy makers and stakeholders, a future version of the model could:

    -   have a "scenario analysis" mode, where users can "add" or "remove" values underlying components (e.g., to simulate a new trail or a new cycle path being added or the change of a landscape due to climate change or socio-economic changes)
    -   allow for direct comparison on how the two (or more) scenarios differ (provide the user with a decrease or increase of Recreational Potential raster.

7.  **JOE and CHRIS to add something if you have other ideas**

## References
